ExperienceReplayBase = {}

ExperienceReplayBase.__index = ExperienceReplayBase

local defaultBatchSize = 32

local defaultMaxBufferSize = 100

local defaultNumberOfExperienceToUpdate = 1

function ExperienceReplayBase.new(batchSize, numberOfExperienceToUpdate, maxBufferSize)
	
	local NewExperienceReplayBase = {}
	
	setmetatable(NewExperienceReplayBase, ExperienceReplayBase)

	NewExperienceReplayBase.batchSize = batchSize or defaultBatchSize

	NewExperienceReplayBase.numberOfExperienceToUpdate = numberOfExperienceToUpdate or defaultNumberOfExperienceToUpdate

	NewExperienceReplayBase.maxBufferSize = maxBufferSize or defaultMaxBufferSize
	
	NewExperienceReplayBase.numberOfExperience = 0
	
	NewExperienceReplayBase.replayBufferArray = {}
	
	return NewExperienceReplayBase
	
end

function ExperienceReplayBase:setParameters(batchSize, numberOfExperienceToUpdate, maxBufferSize)
	
	self.batchSize = batchSize or self.batchSize

	self.numberOfExperienceToUpdate = numberOfExperienceToUpdate or self.numberOfExperienceToUpdate

	self.maxBufferSize = maxBufferSize or self.maxBufferSize
	
end

function ExperienceReplayBase:setResetFunction(resetFunction)
	
	self.resetFunction = resetFunction
	
end

function ExperienceReplayBase:reset()
	
	self.resetFunction()
	
end

function ExperienceReplayBase:setSampleFunction(sampleFunction)
	
	self.sampleFunction = sampleFunction
	
end

function ExperienceReplayBase:sample()

	return self.sampleFunction()
	
end

function ExperienceReplayBase:run(updateFunction)
	
	if (self.numberOfExperience < self.numberOfExperienceToUpdate) then return nil end
	
	self.numberOfExperience = 0

	local experienceReplayBatchArray = self:sample()

	for _, experience in ipairs(experienceReplayBatchArray) do -- (s1, a, r, s2)
		
		local previousState = experience[1]
		
		local action = experience[2]
		
		local rewardValue = experience[3]
		
		local currentState = experience[4]

		updateFunction(previousState, action, rewardValue, currentState)

	end
	
end

function ExperienceReplayBase:addExperience(previousState, action, rewardValue, currentState)
	
	local experience = {previousState, action, rewardValue, currentState}

	table.insert(self.replayBufferArray, experience)

	if (#self.replayBufferArray > self.maxBufferSize) then table.remove(self.replayBufferArray, 1) end
	
	self.numberOfExperience += 1
	
end

return ExperienceReplayBase
